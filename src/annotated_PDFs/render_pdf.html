<html>
<head>
    <script>"<PDFJS>"</script>
    <script>"<PDFJS_WORKER>"</script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsWorker;</script>
    <style>
        .page_container
        {
            margin: 5px;
            position: relative;
        }

        canvas
        {
            border: thin solid black;
            position: absolute;
        }

        .annotations_container, .annotation
        {
            position: absolute;
        }

        .annotation
        {
            background-color: rgba(200, 200, 255, 0.6);
                             /* rgba(254, 255, 200, 0.7); */
            pointer-events: none; /* Later may want to move this to an ".annotation.editing" class */
        }
        .annotation.invalid
        {
            background-color: rgba(255, 50, 50, 0.5);
        }
    </style>
</head>
<body>

    <div id="link_to_pdf_file"></div>

    <div id="pages_container"></div>

    <script>
        const debug_log = false
        const MIN_SIZE = 10

        let highlight_start_x = null
        let highlight_start_y = null
        let highlight_end_x = null
        let highlight_end_y = null
        let highlight_el = null
        let highlight_page_number = null


        function calc_size ()
        {
            const width = highlight_end_x - highlight_start_x
            const height = highlight_end_y - highlight_start_y

            return { width, height }
        }


        function update_highlight_el ()
        {
            const { width, height } = calc_size()

            highlight_el.style.left = width < 0 ? highlight_start_x + width : highlight_start_x
            highlight_el.style.width = width < 0 ? -width : width

            highlight_el.style.top = height < 0 ? highlight_start_y + height : highlight_start_y
            highlight_el.style.height = height < 0 ? -height : height
        }


        function valid_annotation ()
        {
            const { width, height } = calc_size()

            return Math.abs(width) >= MIN_SIZE && Math.abs(height) >= MIN_SIZE
        }


        function create_mouse_handlers ({ page_number, annotations_container })
        {
            function mouse_down_handler ({ x, y })
            {
                debug_log && console.log("mouse down!!", {
                    page_number,
                    highlight_start_x,
                    highlight_start_y,
                    highlight_end_x,
                    highlight_end_y
                })

                highlight_page_number = page_number

                if (highlight_el)
                {
                    highlight_el.remove()
                }

                highlight_el = document.createElement("div")
                highlight_el.className = "annotation"
                annotations_container.appendChild(highlight_el)

                highlight_start_x = highlight_end_x = x
                highlight_start_y = highlight_end_y = y
                update_highlight_el()
            }


            function mouse_moved_handler ({ x, y })
            {
                debug_log && console.log("mouse moved!!", {
                    page_number,
                    highlight_start_x,
                    highlight_start_y,
                    highlight_end_x,
                    highlight_end_y
                })

                if (highlight_page_number !== page_number) return

                highlight_end_x = x
                highlight_end_y = y
                valid_annotation()
                    ? highlight_el.classList.remove("invalid")
                    : highlight_el.classList.add("invalid")
                update_highlight_el()
            }


            function mouse_up_handler ({ x, y })
            {
                debug_log && console.log("mouse up!!", {
                    page_number,
                    highlight_start_x,
                    highlight_start_y,
                    highlight_end_x,
                    highlight_end_y
                })

                if (highlight_page_number !== page_number) return

                highlight_end_x = x
                highlight_end_y = y
                update_highlight_el()
                if (valid_annotation())
                {

                }
                else
                {
                    highlight_el.remove()
                }
                highlight_el = null
                highlight_page_number = null
            }


            return {
                mouse_down_handler,
                mouse_moved_handler,
                mouse_up_handler,
            }
        }
    </script>

    <script>
        function add_canvas_mouse_event_handlers ({ canvas, page_number, annotations_container })
        {
            function create_default_mouse_handlers ({ page_number, annotations_container })
            {
                function mouse_down_handler ({ page_number, x, y })
                {
                    console.log("mouse down", { page_number, x, y })
                }

                function mouse_moved_handler ({ page_number, x, y })
                {
                    console.log("moved", { page_number, x, y })
                }

                function mouse_up_handler ({ page_number, x, y })
                {
                    console.log("mouse_up", { page_number, x, y })
                }

                return {
                    mouse_down_handler,
                    mouse_moved_handler,
                    mouse_up_handler,
                }
            }

            const create_handlers = window["create_mouse_handlers"] || create_default_mouse_handlers
            const {
                mouse_down_handler,
                mouse_moved_handler,
                mouse_up_handler,
            } = create_handlers({ page_number, annotations_container })

            let element = canvas
            let top = 0
            let left = 0
            do {
                top += element.offsetTop  || 0
                left += element.offsetLeft || 0
                element = element.offsetParent
            } while (element)

            canvas.onmousedown = function (e)
            {
                const x = event.clientX - left + document.body.scrollLeft
                const y = event.clientY - top + document.body.scrollTop
                mouse_down_handler({ x, y })
            }

            canvas.onmousemove = function (e)
            {
                const x = event.clientX - left + document.body.scrollLeft
                const y = event.clientY - top + document.body.scrollTop
                mouse_moved_handler({ x, y })
            }

            canvas.onmouseup = function (e)
            {
                const x = event.clientX - left + document.body.scrollLeft
                const y = event.clientY - top + document.body.scrollTop
                mouse_up_handler({ x, y })
            }
        }
    </script>

    <script>
        // https://mozilla.github.io/pdf.js/examples/index.html#interactive-examples

        const pdf_file_data = "<PDF_FILE_DATA_JSON>";

        const path_to_pdf = "/serve_pdf?relative_file_path=" + pdf_file_data["relative_file_path"];

        // show raw link
        const link_to_pdf_el = document.getElementById("link_to_pdf_file")
        link_to_pdf_el.innerHTML = `<a href="${path_to_pdf}">Showing PDF from: ${path_to_pdf}</a>`

        // Render PDF
        const loadingTask = pdfjsLib.getDocument(path_to_pdf)
        loadingTask.promise.then(function(pdf)
        {
            const pages_container_el = document.getElementById("pages_container")

            for (let page_number = 1; page_number <= pdf.numPages; ++page_number)
            {

                pdf.getPage(page_number).then(page =>
                {
                    const page_container = document.createElement("div")
                    page_container.className = "page_container"
                    pages_container_el.appendChild(page_container)
                    pages_container_el.appendChild(document.createElement("br"))

                    const canvas = document.createElement("canvas")
                    const annotations_container = document.createElement("div")
                    annotations_container.className = "annotations_container"
                    page_container.appendChild(canvas)
                    page_container.appendChild(annotations_container)

                    if (window["add_canvas_mouse_event_handlers"])
                    {
                        add_canvas_mouse_event_handlers({ canvas, page_number, annotations_container })
                    }

                    const scale = 1.5
                    const viewport = page.getViewport({ scale: scale })

                    page_container.style.height = viewport.height
                    page_container.style.width = viewport.width
                    canvas.height = viewport.height
                    canvas.width = viewport.width

                    const context = canvas.getContext("2d")
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    }
                    page.render(renderContext)
                })
            }
        })
    </script>
</body>
</html>
