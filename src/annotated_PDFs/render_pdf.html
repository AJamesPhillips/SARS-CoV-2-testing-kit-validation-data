<html>
<head>
    <script>"<PDFJS>"</script>
    <script>"<PDFJS_WORKER>"</script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = pdfjsWorker;</script>
    <style>
        #loading_progress
        {
            text-align: center;
            font-size: 25;
        }

        #pages_container, #annotations_list
        {
            float: left;
        }
        #pages_container
        {
            width: 70%;
        }
        #annotations_list
        {
            width: 30%;
        }

        .page_container
        {
            margin: 5px;
            position: relative;
        }

        canvas
        {
            border: thin solid black;
            position: absolute;
        }

        .annotations_container, .annotation
        {
            position: absolute;
        }

        .annotation
        {
            background-color: rgba(200, 200, 255, 0.6);
                             /* rgba(254, 255, 200, 0.7); */
        }
        .annotation.editing_dimensions
        {
            pointer-events: none;
        }
        .annotation.invalid
        {
            background-color: rgba(255, 50, 50, 0.5);
        }

        .annotation_list_element
        {
            margin: 5px;
            padding: 2px 2px;
            border-radius: 2px;
        }
    </style>

    <style id="programmatic_styles"></style>
</head>
<body>
    <div id="loading_progress"></div>
    <div id="link_to_pdf_file"></div>

    <div>
        <div id="pages_container"></div>
        <div id="annotations_list">
            <h3>List of annotations:</h3>
        </div>
    </div>


    <script>
        const pdf_file_data = "<PDF_FILE_DATA_JSON>";

        const path_to_pdf = "/serve_pdf?relative_file_path=" + pdf_file_data["relative_file_path"]
        const path_to_pdf_annotations = "/annotation?relative_file_path=" + pdf_file_data["relative_file_path"]
    </script>


    <script>

        function parse_location_search ()
        {
            const query = window.location.search.substring(1)
            const vars = {}
            query.split("&").forEach(key_var => {
                const [key, _var] = key_var.split("=")
                vars[decodeURIComponent(key)] = decodeURIComponent(_var)
            })

            return vars
        }

        function get_highlighted_annotation_ids ()
        {
            const vars = parse_location_search()

            const highlighted_annotation_ids = vars["highlighted_annotation_ids"]
                ? vars["highlighted_annotation_ids"].split(",")
                : []

            return highlighted_annotation_ids
        }

        const programmatic_styles_el = document.getElementById("programmatic_styles")
        function update_highlighted_annotations ()
        {
            const highlighted_annotation_ids = get_highlighted_annotation_ids()

            programmatic_styles_el.innerHTML = ""
            if (!highlighted_annotation_ids.length) return
            const class_names = highlighted_annotation_ids.map(id => `.annotation_${id}`).join(",")
            // TODO: remove `!important` hack
            programmatic_styles_el.innerHTML = `${class_names} { background-color: rgba(255, 245, 150, 0.7) !important; }`

            scroll_to_an_annotation({ annotation_ids: highlighted_annotation_ids })
        }

        function scroll_to_an_annotation ({ annotation_ids })
        {
            if (!an_annotation_in_view({ annotation_ids }))
            {
                // console.log("Annotations not in view")
                const annotation_id = annotation_ids[0]
                const el = document.getElementsByClassName(`annotation annotation_${annotation_id}`)[0]
                scroll_to_element(el)
            }
        }

        function an_annotation_in_view ({ annotation_ids })
        {
            let one_in_view = false
            annotation_ids.forEach(id =>
            {
                one_in_view = one_in_view || annotation_in_view(id)
            })
            return one_in_view
        }

        function annotation_in_view (annotation_id)
        {
            const el = document.getElementsByClassName(`annotation annotation_${annotation_id}`)[0]
            return element_in_view(el)
        }

        function element_in_view (el)
        {
            if (!(el && el.getBoundingClientRect)) return false

            const rect = el.getBoundingClientRect()

            return (
                rect.top >= 0 &&
                //rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) //&& /* or $(window).height() */
                //rect.right <= (window.innerWidth || document.documentElement.clientWidth) /* or $(window).width() */
            )
        }

        function scroll_to_element (el)
        {
            if (!(el && el.scrollIntoView)) return false
            el.scrollIntoView()
        }

        function toggle_annotation_highlight (annotation_id)
        {
            const annotation_id_str = annotation_id.toString()
            const highlighted_annotation_ids = get_highlighted_annotation_ids()
            const modified = highlighted_annotation_ids.filter(v => v !== annotation_id_str)
            if (modified.length === highlighted_annotation_ids.length)
            {
                modified.push(annotation_id_str)
            }

            update_page_location({ highlighted_annotation_ids: modified })
        }

        function update_page_location ({ highlighted_annotation_ids })
        {
            const vars = parse_location_search()
            vars["highlighted_annotation_ids"] = highlighted_annotation_ids.join(",")
            const search = []
            Object.keys(vars).forEach(key =>
            {
                search.push(`${key}=${/* encodeURIComponent */(vars[key])}`)
            })
            const search_string = search.join("&")

            var new_url = window.location.protocol + "//" + window.location.host + window.location.pathname + "?" + search_string
            if (history.pushState)
            {
                window.history.pushState({ path: new_url }, "", new_url)
                update_highlighted_annotations()
            }
            else window.location = new_url
        }
    </script>


    <script>
        const annotations_list_el = document.getElementById("annotations_list")

        function record_annotation ({ page_number, left, top, width, height, colour, text, label_ids })
        {
            const data_to_send = JSON.stringify({ page_number, left, top, width, height, colour, text, label_ids });

            fetch(path_to_pdf_annotations, {
                credentials: "same-origin",
                mode: "same-origin",
                method: "post",
                headers: { "Content-Type": "application/json" },
                body: data_to_send
            })
                .then(resp => {
                    if (resp.status === 200) {
                        return resp.json()
                    } else {
                        return Promise.reject("server error")
                    }
                })
                .then(json_data_received => {
                    let data_received = JSON.parse(json_data_received)
                })
                .catch(err => {
                    if (err === "server") return
                    console.log(err)
                })
        }


        function add_annotation_to_list ({ id, page_number, colour, text })
        {
            const annotation_list_el = document.createElement("div")
            annotation_list_el.innerText = `id: ${id}  page: ${page_number}  text: ${text}`
            annotation_list_el.style.backgroundColor = colour
            annotation_list_el.className = `annotation_list_element annotation_${id}`
            annotation_list_el.onclick = () => scroll_to_an_annotation({ annotation_ids: [id] })
            annotations_list_el.appendChild(annotation_list_el)
        }


        function add_annotation ({ id, page_number, left, top, width, height, colour, text, label_ids })
        {
            const annotation = {
                id,
                page_number,
                left,
                top,
                width,
                height,
                colour,
                text,
                label_ids,
            }
            pdf_file_data.annotations.push(annotation)

            add_annotation_to_list(annotation)
            record_annotation(annotation)
        }

    </script>


    <script>
        // Functions to create annotations over PDF
        function get_annotations_container_el_for_page_number ({ page_number })
        {
            return document.getElementById(`annotations_container_el_${page_number}`)
        }

        function create_empty_annotation ({ id, page_number, editing_dimensions })
        {
            const annotation_el = document.createElement("div")
            annotation_el.className = `annotation annotation_${id}` + (editing_dimensions ? " editing_dimensions" : "")
            const annotations_container_el = get_annotations_container_el_for_page_number({ page_number })
            annotations_container_el.appendChild(annotation_el)
            annotation_el.onclick = () => toggle_annotation_highlight(id)

            return annotation_el
        }

        function create_annotation ({ id, page_number, left, top, width, height, colour, text, label_ids })
        {
            const annotation_el = create_empty_annotation({ id, page_number, editing_dimensions: false })
            annotation_el.style.left = left
            annotation_el.style.top = top
            annotation_el.style.width = width
            annotation_el.style.height = height
            annotation_el.style.backgroundColor = colour
            annotation_el.title = text
        }
    </script>

    <script>
        // Create mouse handlers factory for handling mouse events from
        // PDF
        // Dependency on add_annotation

        const debug_log = false
        const MIN_SIZE = 10

        let highlight_start_x = null
        let highlight_start_y = null
        let highlight_end_x = null
        let highlight_end_y = null
        let temp_annotation_el = null
        let temp_annotation_id = -1;
        let highlight_page_number = null


        function calc_size ()
        {
            const width = highlight_end_x - highlight_start_x
            const height = highlight_end_y - highlight_start_y

            return { width, height }
        }


        function update_temp_annotation_el ()
        {
            const { width, height } = calc_size()

            temp_annotation_el.style.left = width < 0 ? highlight_start_x + width : highlight_start_x
            temp_annotation_el.style.width = width < 0 ? -width : width

            temp_annotation_el.style.top = height < 0 ? highlight_start_y + height : highlight_start_y
            temp_annotation_el.style.height = height < 0 ? -height : height
        }


        function valid_annotation ()
        {
            const { width, height } = calc_size()

            return Math.abs(width) >= MIN_SIZE && Math.abs(height) >= MIN_SIZE
        }


        function create_mouse_handlers ({ page_number })
        {
            function mouse_down_handler ({ x, y })
            {
                debug_log && console.log("mouse down!!", {
                    page_number,
                    highlight_start_x,
                    highlight_start_y,
                    highlight_end_x,
                    highlight_end_y
                })

                highlight_page_number = page_number

                if (temp_annotation_el)
                {
                    temp_annotation_el.remove()
                }

                temp_annotation_el = create_empty_annotation({ id: temp_annotation_id, page_number, editing_dimensions: true })

                highlight_start_x = highlight_end_x = x
                highlight_start_y = highlight_end_y = y
                update_temp_annotation_el()
            }


            function mouse_moved_handler ({ x, y })
            {
                debug_log && console.log("mouse moved!!", {
                    page_number,
                    highlight_start_x,
                    highlight_start_y,
                    highlight_end_x,
                    highlight_end_y
                })

                if (highlight_page_number !== page_number) return

                highlight_end_x = x
                highlight_end_y = y
                valid_annotation()
                    ? temp_annotation_el.classList.remove("invalid")
                    : temp_annotation_el.classList.add("invalid")
                update_temp_annotation_el()
            }


            function mouse_up_handler ({ x, y })
            {
                debug_log && console.log("mouse up!!", {
                    page_number,
                    highlight_start_x,
                    highlight_start_y,
                    highlight_end_x,
                    highlight_end_y
                })

                if (highlight_page_number !== page_number) return

                highlight_end_x = x
                highlight_end_y = y
                update_temp_annotation_el()
                if (!valid_annotation())
                {
                    temp_annotation_el.remove()
                }
                else if (window["add_annotation"])
                {
                    const annotation = {
                        id: temp_annotation_id--,
                        page_number,
                        left: temp_annotation_el.style.left,
                        top: temp_annotation_el.style.top,
                        width: temp_annotation_el.style.width,
                        height: temp_annotation_el.style.height,
                        // colour: temp_annotation_el.style.backgroundColor,
                        colour: window.getComputedStyle(temp_annotation_el).backgroundColor,
                        text: "",
                        label_ids: [],
                    }
                    add_annotation(annotation)
                    temp_annotation_el.classList.remove("editing_dimensions")
                }
                temp_annotation_el = null
                highlight_page_number = null
            }


            return {
                mouse_down_handler,
                mouse_moved_handler,
                mouse_up_handler,
            }
        }
    </script>

    <script>
        function get_element_position (element)
        {
            let top = 0
            let left = 0
            do {
                top += element.offsetTop  || 0
                left += element.offsetLeft || 0
                element = element.offsetParent
            } while (element)

            return { top, left }
        }
    </script>

    <script>
        // mouse event handler factory
        // dependency on create_mouse_handlers

        function add_canvas_mouse_event_handlers ({ canvas, page_number })
        {
            function create_default_mouse_handlers ({ page_number })
            {
                function mouse_down_handler ({ page_number, x, y })
                {
                    console.log("mouse down", { page_number, x, y })
                }

                function mouse_moved_handler ({ page_number, x, y })
                {
                    console.log("moved", { page_number, x, y })
                }

                function mouse_up_handler ({ page_number, x, y })
                {
                    console.log("mouse_up", { page_number, x, y })
                }

                return {
                    mouse_down_handler,
                    mouse_moved_handler,
                    mouse_up_handler,
                }
            }

            const create_handlers = window["create_mouse_handlers"] || create_default_mouse_handlers
            const {
                mouse_down_handler,
                mouse_moved_handler,
                mouse_up_handler,
            } = create_handlers({ page_number })

            let position_set = false
            let left = undefined
            let top = undefined

            canvas.onmousedown = function (e)
            {
                const position = get_element_position(canvas)
                left = position.left
                top = position.top
                position_set = true

                const x = event.clientX - left + document.body.scrollLeft
                const y = event.clientY - top + document.body.scrollTop
                mouse_down_handler({ x, y })
            }

            canvas.onmousemove = function (e)
            {
                if (!position_set) return

                const x = event.clientX - left + document.body.scrollLeft
                const y = event.clientY - top + document.body.scrollTop
                mouse_moved_handler({ x, y })
            }

            canvas.onmouseup = function (e)
            {
                if (!position_set) return

                const x = event.clientX - left + document.body.scrollLeft
                const y = event.clientY - top + document.body.scrollTop
                mouse_up_handler({ x, y })
                position_set = false
            }
        }
    </script>

    <script>
        // show raw link
        const link_to_pdf_el = document.getElementById("link_to_pdf_file")
        link_to_pdf_el.innerHTML = `<a href="${path_to_pdf}">Showing PDF from: ${path_to_pdf}</a>`

        // show list of annotations
        pdf_file_data.annotations.forEach(add_annotation_to_list)

        // Add annotations to PDF
        function add_annotations_to_PDF_page ({ page_number })
        {
            pdf_file_data.annotations.filter(annotation => {
                return annotation.page_number === page_number
            })
            .forEach(annotation => {
                create_annotation(annotation)
            })
        }
    </script>

    <script>
        let _max_pages = undefined
        let loading_progress_el = document.getElementById("loading_progress")
        function update_loading_progress ({ page_number, max_pages })
        {
            page_number = page_number || 0
            if (max_pages) _max_pages = max_pages
            else max_pages = _max_pages

            const progress = ((page_number / max_pages) * 100).toFixed(0)
            loading_progress_el.innerText = `Progress: ${progress}%`
            if (page_number === max_pages) setTimeout(() => {
                loading_progress_el.style.display = "none"
            }, 500)
        }
    </script>

    <script>
        // Render the PDF
        //   Dependency on adding mouse event handlers
        // https://mozilla.github.io/pdf.js/examples/index.html#interactive-examples

        const loadingTask = pdfjsLib.getDocument(path_to_pdf)
        loadingTask.promise.then(function(pdf)
        {
            const pages_container_el = document.getElementById("pages_container")

            update_loading_progress({ max_pages: pdf.numPages })
            // assume there is always at least 1 page to render
            render_pdf_page({ pdf, pages_container_el, page_number: 1 })
        })

        function render_pdf_page ({ pdf, pages_container_el, page_number })
        {
            pdf.getPage(page_number).then(page =>
            {
                const page_container = document.createElement("div")
                page_container.className = "page_container"
                pages_container_el.appendChild(page_container)
                const page_number_el = document.createElement("div")
                page_number_el.innerText = page_number
                pages_container_el.appendChild(page_number_el)
                pages_container_el.appendChild(document.createElement("br"))

                const canvas = document.createElement("canvas")
                const annotations_container_el = document.createElement("div")
                annotations_container_el.className = "annotations_container"
                annotations_container_el.id = `annotations_container_el_${page_number}`

                page_container.appendChild(canvas)
                page_container.appendChild(annotations_container_el)

                if (window["add_canvas_mouse_event_handlers"])
                {
                    add_canvas_mouse_event_handlers({ canvas, page_number })
                }

                const scale = 1.5
                const viewport = page.getViewport({ scale: scale })

                page_container.style.height = viewport.height
                page_container.style.width = viewport.width
                canvas.height = viewport.height
                canvas.width = viewport.width

                const context = canvas.getContext("2d")
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                }
                page.render(renderContext)
                .promise.then(() =>
                {
                    add_annotations_to_PDF_page({ page_number })
                    update_loading_progress({ page_number })

                    if (page_number < pdf.numPages)
                    {
                        render_pdf_page({
                            pdf,
                            pages_container_el,
                            page_number: page_number + 1,
                        })
                    }
                    else
                    {
                        finished_rendering_pdf()
                    }
                })
            })
        }

        function finished_rendering_pdf ()
        {
            update_highlighted_annotations()
        }
    </script>
</body>
</html>
